name: CI

on:
  workflow_dispatch:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  merge_group:
    types: [checks_requested]

jobs:
  build:
    runs-on: ubuntu-latest
    container: quay.io/fedora/fedora:43

    steps:
      - uses: actions/checkout@v6

      - name: Install build dependencies
        run: sudo dnf -y install clang cmake gtk4-devel ibus-devel libadwaita-devel libchewing-devel ibus gettext weston

      - name: Build
        run: |
          cmake --preset c23-release-ci
          cmake --build --preset c23-release-ci --verbose
          cmake --build build -t install --verbose

      - name: Test
        env:
          XDG_RUNTIME_DIR: /tmp
        run: |
          glib-compile-schemas src/setup --targetdir=build/bin
          weston -Bheadless -- ctest --test-dir build --verbose

  build-meson:
    runs-on: ubuntu-latest
    container: quay.io/fedora/fedora:43

    steps:
      - uses: actions/checkout@v6

      - name: Install build dependencies
        run: sudo dnf -y install gcc meson gtk4-devel ibus-devel libadwaita-devel libchewing-devel ibus gettext weston

      - name: Build
        run: |
          meson setup build
          meson compile -C build
          meson install -n -C build

      - name: Test
        env:
          XDG_RUNTIME_DIR: /tmp
        run: |
          weston -Bheadless -- meson test -C build --print-errorlogs

  coverage:
    runs-on: ubuntu-latest
    container: quay.io/fedora/fedora:43

    steps:
      - uses: actions/checkout@v6

      - name: Install build dependencies
        run: sudo dnf -y install clang cmake gtk4-devel ibus-devel libadwaita-devel libchewing-devel ibus gettext weston

      - name: Install llvm
        run: |
          sudo dnf -y install llvm rustup bzip2 git
          rustup-init -y
          source "$HOME/.cargo/env"
          rustup component add llvm-tools

      - name: Setup grcov
        run: |
          curl -LO https://github.com/mozilla/grcov/releases/download/v0.10.5/grcov-x86_64-unknown-linux-gnu.tar.bz2
          echo 80df5b760e901d56b28515584311137ffcd332eb7375b452b22a9538851d0993 grcov-x86_64-unknown-linux-gnu.tar.bz2 | sha256sum -c -
          tar xf grcov-x86_64-unknown-linux-gnu.tar.bz2

      - name: Build
        run: |
          cmake --preset c23-coverage
          cmake --build --preset c23-coverage --verbose
          cmake --build build -t install --verbose

      - name: Test
        env:
          XDG_RUNTIME_DIR: /tmp
          LLVM_PROFILE_FILE: "default_%p_%m.profraw"
        run: |
          source "$HOME/.cargo/env"
          glib-compile-schemas src/setup --targetdir=build/bin
          weston -Bheadless -- ctest --test-dir build --verbose
          ./grcov . -s . -b . --keep-only 'src/*' --llvm  -t lcov -o coverage.lcov

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  coverage-meson:
    runs-on: ubuntu-latest
    container: quay.io/fedora/fedora:43

    steps:
      - uses: actions/checkout@v6

      - name: Install build dependencies
        run: sudo dnf -y install gcc gcovr meson gtk4-devel ibus-devel libadwaita-devel libchewing-devel ibus gettext weston git

      - name: Build
        run: |
          meson setup -Db_coverage=true build
          meson compile -C build

      - name: Test
        env:
          XDG_RUNTIME_DIR: /tmp
        run: |
          weston -Bheadless -- meson test -C build --print-errorlogs
          ninja -C build coverage-xml

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # https://github.com/orgs/community/discussions/26822
  results:
    if: ${{ always() }}
    runs-on: ubuntu-latest
    name: Final Results
    needs: [build]
    steps:
      - run: exit 1
        # see https://stackoverflow.com/a/67532120/4907315
        if: >-
          ${{
               contains(needs.*.result, 'failure')
            || contains(needs.*.result, 'cancelled')
          }}
